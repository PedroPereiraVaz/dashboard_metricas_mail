<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="dashboard_metricas_mail.MarketingDashboard" owl="1">
        <div class="o_marketing_dashboard h-100 overflow-auto p-3">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 gap-2">
                <h1 class="text-primary fw-bold">Email Marketing Dashboard</h1>
                <div class="d-flex flex-column flex-md-row gap-2 align-items-center">
                    
                    <select class="form-select" name="campaign_id" t-model="state.filters.campaign_id" t-on-change="onFilterChange" style="width: 250px;">
                        <option value="">All Campaigns</option>
                        <t t-foreach="state.options.campaigns" t-as="campaign" t-key="campaign.id">
                            <option t-att-value="campaign.id" t-esc="campaign.name"/>
                        </t>
                    </select>
                    
                    <select class="form-select" name="mailing_id" t-model="state.filters.mailing_id" t-on-change="onFilterChange" style="width: 250px;">
                        <option value="">All Mailings</option>
                        <t t-foreach="state.options.mailings" t-as="mailing" t-key="mailing.id">
                            <option t-att-value="mailing.id" t-esc="mailing.name"/>
                        </t>
                    </select>

                </div>
            </div>

            <div t-if="state.loading" class="text-center p-5">
                <i class="fa fa-spinner fa-spin fa-3x text-muted"/>
            </div>

            <div t-else="" class="container-fluid">
                <!-- Deliverability Section -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h3 class="text-primary mb-2"><i class="fa fa-paper-plane me-2"/>Deliverability &amp; Quality</h3>
                    </div>
                    <div class="col-md">
                        <div class="card shadow-sm border-0 mb-2 metric-card bg-gradient-info text-white cursor-pointer" t-on-click="() => this.openDeliverability('total')">
                            <div class="card-body">
                                <h5 class="deliverability-title">Total</h5>
                                <div class="text-center">
                                    <h2 class="display-6 metric-value text-white" t-esc="formatNumber(state.metrics.deliverability.total)"/>
                                    <small>Rate: <t t-esc="formatPercentage(100)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card shadow-sm border-0 mb-2 metric-card bg-gradient-primary text-white cursor-pointer" t-on-click="() => this.openDeliverability('sent')">
                            <div class="card-body">
                                <h5 class="deliverability-title">Sent</h5>
                                <div class="text-center">
                                    <h2 class="display-6 metric-value text-white" t-esc="formatNumber(state.metrics.deliverability.sent)"/>
                                    <small>Rate: <t t-esc="formatPercentage(state.metrics.deliverability.sent_rate)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card shadow-sm border-0 mb-2 metric-card bg-gradient-success text-white cursor-pointer" t-on-click="() => this.openDeliverability('delivered')">
                            <div class="card-body">
                                <h5 class="deliverability-title">Delivered</h5>
                                <div class="text-center">
                                    <h2 class="display-6 metric-value text-white" t-esc="formatNumber(state.metrics.deliverability.delivered)"/>
                                    <small>Rate: <t t-esc="formatPercentage(state.metrics.deliverability.delivery_rate)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card shadow-sm border-0 mb-2 metric-card bg-gradient-warning text-white cursor-pointer" t-on-click="() => this.openDeliverability('bounced')">
                            <div class="card-body">
                                <h5 class="deliverability-title">Bounced</h5>
                                <div class="text-center">
                                    <h2 class="display-6 metric-value text-white" t-esc="formatNumber(state.metrics.deliverability.bounced)"/>
                                    <small>Rate: <t t-esc="formatPercentage(state.metrics.deliverability.bounce_rate)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md">
                        <div class="card shadow-sm border-0 mb-2 metric-card bg-gradient-danger text-white cursor-pointer" t-on-click="() => this.openDeliverability('exception')">
                            <div class="card-body">
                                <h5 class="deliverability-title">Exception</h5>
                                <div class="text-center">
                                    <h2 class="display-6 metric-value text-white" t-esc="formatNumber(state.metrics.deliverability.exception)"/>
                                    <small>Rate: <t t-esc="formatPercentage(state.metrics.deliverability.exception_rate)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Engagement Section -->
                <div class="row mb-3">
                    <div class="col-12">
                        <h3 class="text-primary mb-2"><i class="fa fa-users me-2"/>Engagement</h3>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm border-0 mb-2 cursor-pointer" t-on-click="() => this.openEngagement('open')">
                            <div class="card-body">
                                <h6 class="metric-title text-muted">Open Rate</h6>
                                <div class="text-center">
                                    <h2 class="text-primary metric-value" t-esc="formatPercentage(state.metrics.engagement.open_rate)"/>
                                    <small class="text-muted"><t t-esc="formatNumber(state.metrics.engagement.total_opens)"/> Opens</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm border-0 mb-2 cursor-pointer" t-on-click="() => this.openEngagement('click')">
                            <div class="card-body">
                                <h6 class="metric-title text-muted">Click Rate (CTR)</h6>
                                <div class="text-center">
                                    <h2 class="text-info metric-value" t-esc="formatPercentage(state.metrics.engagement.click_rate)"/>
                                    <small class="text-muted"><t t-esc="formatNumber(state.metrics.engagement.total_clicks)"/> Clicks</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm border-0 mb-2 cursor-pointer" t-on-click="() => this.openEngagement('reply')">
                            <div class="card-body">
                                <h6 class="metric-title text-muted">Reply Rate</h6>
                                <div class="text-center">
                                    <h2 class="text-warning metric-value" t-esc="formatPercentage(state.metrics.engagement.reply_rate)"/>
                                    <small class="text-muted"><t t-esc="formatNumber(state.metrics.engagement.total_replies)"/> Replies</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm border-0 mb-2 cursor-pointer" t-on-click="() => this.openEngagement('ctor')">
                            <div class="card-body">
                                <h6 class="metric-title text-muted">Click-to-Open (CTOR)</h6>
                                <div class="text-center">
                                    <h2 class="text-success metric-value" t-esc="formatPercentage(state.metrics.engagement.ctor)"/>
                                    <small class="text-muted">Clicks: <t t-esc="formatNumber(state.metrics.engagement.total_clicks)"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Conversion Section -->
                <!-- Conversion Section -->
                <div class="row mb-3">
                    <!-- Consolidated Metrics (Left Side) -->
                    <div class="col-md-8">
                        <h3 class="text-primary mb-2"><i class="fa fa-dollar me-2"/>Conversion</h3>
                        <div class="row">
                            <!-- Total Revenue -->
                            <div class="col-md-3">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('total')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Total Revenue</h6>
                                        <h4 class="metric-value mb-0 text-success" t-esc="formatCurrency(state.metrics.conversion.total_revenue)"/>
                                    </div>
                                </div>
                            </div>
                            <!-- Rev. per Email -->
                            <div class="col-md-3">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('total')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Rev. per Email</h6>
                                        <h4 class="metric-value mb-0 text-dark" t-esc="formatCurrency(state.metrics.conversion.revenue_per_email)"/>
                                    </div>
                                </div>
                            </div>
                            <!-- Total Conversions -->
                            <div class="col-md-3">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('total')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Total Conv.</h6>
                                        <h4 class="metric-value mb-0 text-success" t-esc="formatNumber(state.metrics.conversion.total_conversions)"/>
                                    </div>
                                </div>
                            </div>
                            <!-- Conv. Rate -->
                            <div class="col-md-3">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('total')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Conv. Rate</h6>
                                        <h4 class="metric-value mb-0 text-dark" t-esc="formatPercentage(state.metrics.conversion.conversion_rate)"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Potential Metrics (Right Side) -->
                    <div class="col-md-4">
                        <h3 class="text-primary mb-2"><i class="fa fa-line-chart me-2"/>Potential Conversions</h3>
                        <div class="row">
                            <!-- Potential Revenue -->
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('potential')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Potential Rev.</h6>
                                        <h4 class="metric-value mb-0 text-info" t-esc="formatCurrency(state.metrics.conversion.potential_revenue)"/>
                                    </div>
                                </div>
                            </div>
                            <!-- Potential Conversions -->
                            <div class="col-md-6">
                                <div class="card shadow-sm border-0 mb-3 cursor-pointer" t-on-click="() => this.openConversion('potential')">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="metric-title small text-muted">Potential Conv.</h6>
                                        <h4 class="metric-value mb-0 text-info" t-esc="formatNumber(state.metrics.conversion.potential_conversions)"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- List Health & Automation -->
                <!-- Top Links, List Health, Campaign Stages -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <h3 class="text-primary mb-2"><i class="fa fa-link me-2"/>Top Clicked Links</h3>
                        <div class="card shadow-sm border-0 p-3">
                            <ul class="list-group list-group-flush" t-if="state.metrics.top_links.length > 0">
                                <t t-foreach="state.metrics.top_links" t-as="link" t-key="link.id">
                                    <li class="list-group-item d-flex justify-content-between align-items-center mb-1 rounded shadow-sm metric-card bg-light text-dark cursor-pointer" t-on-click="() => this.openLinkStats(link)">
                                        <span class="text-truncate fw-bold text-dark metric-list-text" style="max-width: 80%;" t-esc="link.name"/>
                                        <span class="badge bg-primary rounded-pill metric-list-text text-white" t-esc="formatNumber(link.count)"/>
                                    </li>
                                </t>
                            </ul>
                            <div t-else="" class="text-center text-muted p-2">
                                No clicks recorded.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-primary mb-2"><i class="fa fa-heartbeat me-2"/>List Health</h3>
                        <div class="card shadow-sm border-0 p-3">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer metric-card bg-gradient-warning text-white mb-1 rounded shadow-sm" t-on-click="() => this.openContacts('all')">
                                    <span class="metric-list-text">Total Contacts</span>
                                    <span class="badge bg-white text-warning rounded-pill metric-list-text" t-esc="formatNumber(state.metrics.list_health.total_contacts)"/>
                                </li>
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer metric-card bg-gradient-primary text-white mb-1 rounded shadow-sm" t-on-click="() => this.openContacts('active')">
                                    <span class="metric-list-text">Active Contacts</span>
                                    <span class="badge bg-white text-blue rounded-pill metric-list-text" t-esc="formatNumber(state.metrics.list_health.active_contacts)"/>
                                </li>
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer metric-card bg-gradient-success text-white mb-1 rounded shadow-sm" t-on-click="() => this.openContacts('new')">
                                    <span class="metric-list-text">New (30d)</span>
                                    <span class="badge bg-white text-success rounded-pill metric-list-text" t-esc="formatNumber(state.metrics.list_health.new_contacts_30d)"/>
                                </li>
                                <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer metric-card bg-dark-gray text-white mb-1 rounded shadow-sm" t-on-click="() => this.openContacts('blacklisted')">
                                    <span class="metric-list-text">Blacklisted</span>
                                    <span class="badge bg-white text-dark rounded-pill metric-list-text" t-esc="formatNumber(state.metrics.list_health.blacklisted)"/>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-primary mb-2"><i class="fa fa-columns me-2"/>Campaign Stages</h3>
                        <div class="card shadow-sm border-0 p-3">
                            <ul class="list-group list-group-flush" t-if="state.metrics.campaign_stages.has_stages">
                                <t t-foreach="state.metrics.campaign_stages.stages" t-as="stage" t-key="stage.id">
                                    <li t-att-class="'list-group-item list-group-item-action d-flex justify-content-between align-items-center cursor-pointer metric-card text-white mb-1 rounded shadow-sm ' + getStageColor(stage.name)" t-on-click="() => this.openStage(stage.id)">
                                        <span class="metric-list-text"><t t-esc="stage.name"/></span>
                                        <span t-att-class="'badge bg-white rounded-pill metric-list-text ' + getStageBadgeColor(stage.name)" t-esc="formatNumber(stage.count)"/>
                                    </li>
                                </t>
                            </ul>
                            <div t-else="" class="text-center text-muted p-3">
                                No campaign stages defined.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>
